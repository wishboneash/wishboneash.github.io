<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Custom Messenger UI D</title>
    <script src="https://apps.mypurecloud.de/genesys-bootstrap/genesys.min.js"></script>
    <script>
        let conversationStarted = false;

        // Initialize Genesys Web Messenger

        (function (g, e, n, es, ys) {
          g['_genesysJs'] = e;
          g[e] = g[e] || function () {
            (g[e].q = g[e].q || []).push(arguments)
          };
          g[e].t = 1 * new Date();
          g[e].c = es;
          ys = document.createElement('script'); ys.async = 1; ys.src = n; ys.charset = 'utf-8'; document.head.appendChild(ys);
        })(window, 'Genesys', 'https://apps.mypurecloud.de/genesys-bootstrap/genesys.min.js', {
          environment: 'prod-euc1',
          deploymentId: '74c21148-3dd7-4d64-ba92-2a250fc7aa94',
          debug: true 
        });

        Genesys("subscribe", "MessagingService.ready", function () {
            console.log("MessagingService is ready.");

            document.getElementById('startChat').addEventListener('click', function () {
                Genesys("command", "MessagingService.startConversation", {}, function () {
                    console.log("Conversation start command sent.");
                }, function (err) {
                    console.log("Start conversation failed:", err);
                });
            });

            document.getElementById('clearChat').addEventListener('click', function () {
                Genesys("command", "MessagingService.clearConversation", {}, function () {
                    console.log("Conversation cleared.");
                    document.getElementById('chatWindow').innerHTML = '';
                    conversationStarted = false;
                }, function (err) {
                    console.error("Clear conversation failed:", err);
                });
            });
        });

        Genesys("subscribe", "MessagingService.started", function ({data}) {
            console.log("Conversation officially started.", data);
            conversationStarted = true;
            const chatWindow = document.getElementById('chatWindow');
            const msgElem = document.createElement('div');
            msgElem.textContent = "[Conversation Started]";
            msgElem.style.color = "green";
            chatWindow.appendChild(msgElem);
        });

        Genesys("subscribe", "MessagingService.messageReceived", function (event) {
            const message = event.data.message.text;
            const chatWindow = document.getElementById('chatWindow');
            const msgElem = document.createElement('div');
            msgElem.textContent = `Agent: ${message}`;
            chatWindow.appendChild(msgElem);
        });

        Genesys("subscribe", "MessagingService.error", function (error) {
            console.log("MessagingService error occurred:", error);
            const chatWindow = document.getElementById('chatWindow');
            const msgElem = document.createElement('div');
            msgElem.textContent = `[Error]: ${error.message || 'Unknown error'}`;
            msgElem.style.color = "red";
            chatWindow.appendChild(msgElem);
        });

        function sendMessage() {
            const message = document.getElementById('messageInput').value;
            if (!message.trim()) return;

            if (!conversationStarted) {
                console.log("Conversation hasn't started yet.");
                alert("Please start the conversation first.");
                return;
            }

            Genesys("command", "MessagingService.sendMessage", { text: message }, function () {
                const chatWindow = document.getElementById('chatWindow');
                const msgElem = document.createElement('div');
                msgElem.textContent = `You: ${message}`;
                chatWindow.appendChild(msgElem);
                document.getElementById('messageInput').value = '';
            }, function (err) {
                console.error("Send message failed:", err);
            });
        }
    </script>
</head>
<body>
    <div id="customChatUI">
        <button id="startChat">Start Chat</button>
        <button id="clearChat">Clear Conversation</button>

        <div id="chatWindow" style="border:1px solid #ccc; padding:10px; margin:10px 0; height:200px; overflow-y:auto;">
            <!-- Messages will appear here -->
        </div>

        <input type="text" id="messageInput" placeholder="Type your message..." />
        <button onclick="sendMessage()">Send</button>
    </div>
</body>
</html>
